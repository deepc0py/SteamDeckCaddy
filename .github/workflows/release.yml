name: Build and Release

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: write

env:
  FLUTTER_VERSION: '3.22.2'
  CMAKE_VERSION: '3.15'

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache Homebrew packages
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/Cellar
          /usr/local/var/homebrew
        key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/**') }}
        restore-keys: |
          ${{ runner.os }}-brew-

    - name: Setup Flutter with cache
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Install dependencies
      run: |
        # Install Homebrew dependencies for libwarpdeck
        brew install openssl brotli pkg-config

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'
        
    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          /usr/local/share/vcpkg/installed
          ${{ env.VCPKG_ROOT }}/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json', '**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Install C++ dependencies
      run: |
        $VCPKG_ROOT/vcpkg install boost-asio openssl nlohmann-json

    - name: Build libwarpdeck
      run: |
        cd libwarpdeck
        rm -rf build
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
              ..
        make -j$(sysctl -n hw.ncpu)
        cd ../..

    - name: Build CLI
      run: |
        cd warpdeck-cli
        rm -rf build
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
              ..
        make -j$(sysctl -n hw.ncpu)
        cd ../..

    - name: Build Flutter GUI
      run: |
        cd warpdeck-flutter/warpdeck_gui
        flutter pub get
        dart run build_runner build --delete-conflicting-outputs
        flutter build macos --release

    - name: Fix macOS dependencies
      run: |
        cd warpdeck-flutter/warpdeck_gui
        chmod +x fix_macos_dependencies.sh
        ./fix_macos_dependencies.sh

    - name: Create DMG
      run: |
        cd warpdeck-flutter/warpdeck_gui/build/macos/Build/Products/Release
        
        # Create a temporary directory for DMG contents
        mkdir -p dmg_temp
        cp -R warpdeck_gui.app dmg_temp/WarpDeck.app
        
        # Create Applications symlink
        ln -s /Applications dmg_temp/Applications
        
        # Create DMG
        hdiutil create -volname "WarpDeck" -srcfolder dmg_temp -ov -format UDZO WarpDeck-macOS.dmg
        
        # Move DMG to workspace root for upload  
        echo "📍 Current directory: $(pwd)"
        echo "📁 Files before move: $(ls -la WarpDeck-macOS.dmg)"
        
        # Calculate path to workspace root from current location
        # We're in: warpdeck-flutter/warpdeck_gui/build/macos/Build/Products/Release
        # We need to go up 7 levels to get to workspace root
        mv WarpDeck-macOS.dmg ../../../../../../..
        echo "✅ DMG moved to workspace root"
        cd ../../../../../../..
        echo "📍 Workspace root directory: $(pwd)"
        echo "📁 DMG at workspace root: $(ls -la WarpDeck-macOS.dmg)"

    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v4
      with:
        name: warpdeck-macos
        path: |
          WarpDeck-macOS.dmg
          warpdeck-cli/build/warpdeck

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: cmake build-essential pkg-config libssl-dev libavahi-client-dev libgtk-3-dev ninja-build clang libayatana-appindicator3-dev librsvg2-bin imagemagick
        version: 1.0

    - name: Setup Flutter with cache
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        cache: true

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'
        
    - name: Cache vcpkg packages
      uses: actions/cache@v4
      with:
        path: |
          /usr/share/vcpkg/installed
          ${{ env.VCPKG_ROOT }}/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('**/vcpkg.json', '**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Install C++ dependencies
      run: |
        $VCPKG_ROOT/vcpkg install boost-asio openssl nlohmann-json

    - name: Build libwarpdeck
      run: |
        cd libwarpdeck
        rm -rf build
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
              ..
        make -j$(nproc)
        cd ../..

    - name: Build CLI
      run: |
        cd warpdeck-cli
        rm -rf build
        mkdir -p build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
              ..
        make -j$(nproc)
        cd ../..

    - name: Build Flutter GUI
      run: |
        cd warpdeck-flutter/warpdeck_gui
        flutter pub get
        dart run build_runner build --delete-conflicting-outputs
        flutter build linux --release

    - name: Create AppImage
      run: |
        # Download AppImage tools
        wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        chmod +x appimagetool-x86_64.AppImage
        
        # Extract the AppImage tool since FUSE is not available in CI
        ./appimagetool-x86_64.AppImage --appimage-extract
        APPIMAGE_TOOL="$(pwd)/squashfs-root/AppRun"
        
        cd warpdeck-flutter/warpdeck_gui/build/linux/x64/release/bundle
        
        # Create AppDir structure
        mkdir -p WarpDeck.AppDir/usr/bin
        mkdir -p WarpDeck.AppDir/usr/share/applications
        mkdir -p WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Copy application files (exclude the AppDir we just created)
        for item in *; do
          if [ "$item" != "WarpDeck.AppDir" ]; then
            cp -r "$item" WarpDeck.AppDir/usr/bin/
          fi
        done
        
        # Create desktop file
        cat > WarpDeck.AppDir/usr/share/applications/warpdeck.desktop << EOF
        [Desktop Entry]
        Type=Application
        Name=WarpDeck
        Comment=Secure peer-to-peer file sharing
        Exec=warpdeck_gui
        Icon=warpdeck
        Categories=Network;FileTransfer;
        EOF
        
        # Copy and prepare icons for AppImage
        echo "🔍 Searching for icon files..."
        find . -name "*warpdeck*" -type f | head -10
        find . -name "*icon*" -type f | grep -E "\.(png|svg)$" | head -10
        
        ICON_COPIED=false
        
        # Check multiple possible icon paths based on the search results
        ICON_PATHS=(
          "usr/bin/data/flutter_assets/assets/icons/warpdeck.png"
          "data/flutter_assets/assets/icons/warpdeck.png"
          "WarpDeck.AppDir/usr/bin/data/flutter_assets/assets/icons/warpdeck.png"
        )
        
        SVG_PATHS=(
          "usr/bin/data/flutter_assets/assets/icons/warpdeck.svg"
          "data/flutter_assets/assets/icons/warpdeck.svg"
          "WarpDeck.AppDir/usr/bin/data/flutter_assets/assets/icons/warpdeck.svg"
        )
        
        # Try PNG first (direct copy)
        for png_path in "${ICON_PATHS[@]}"; do
          if [ -f "$png_path" ]; then
            echo "✅ Found PNG icon at: $png_path"
            cp "$png_path" WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps/warpdeck.png
            cp "$png_path" WarpDeck.AppDir/warpdeck.png
            ICON_COPIED=true
            break
          fi
        done
        
        # Try SVG conversion if PNG not found
        if [ "$ICON_COPIED" = "false" ]; then
          for svg_path in "${SVG_PATHS[@]}"; do
            if [ -f "$svg_path" ]; then
              echo "✅ Found SVG icon at: $svg_path"
              rsvg-convert -w 256 -h 256 -o WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps/warpdeck.png "$svg_path"
              cp WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps/warpdeck.png WarpDeck.AppDir/warpdeck.png
              ICON_COPIED=true
              break
            fi
          done
        fi
        
        # Create placeholder if no icon found
        if [ "$ICON_COPIED" = "false" ]; then
          echo "❌ No suitable icon found! Creating placeholder with ImageMagick..."
          # Create a simple colored square as placeholder using ImageMagick
          magick -size 256x256 xc:'#2196F3' WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps/warpdeck.png
          cp WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps/warpdeck.png WarpDeck.AppDir/warpdeck.png
          ICON_COPIED=true
        fi
        
        if [ "$ICON_COPIED" = "true" ]; then
          echo "✅ Icon successfully placed at:"
          ls -la WarpDeck.AppDir/warpdeck.png
          ls -la WarpDeck.AppDir/usr/share/icons/hicolor/256x256/apps/warpdeck.png
        fi
        
        # Create AppRun
        cat > WarpDeck.AppDir/AppRun << EOF
        #!/bin/bash
        HERE="\$(dirname "\$(readlink -f "\${0}")")"
        exec "\${HERE}/usr/bin/warpdeck_gui" "\$@"
        EOF
        chmod +x WarpDeck.AppDir/AppRun
        
        # Copy desktop file to root
        cp WarpDeck.AppDir/usr/share/applications/warpdeck.desktop WarpDeck.AppDir/
        
        
        # Build AppImage
        if [ ! -f "$APPIMAGE_TOOL" ]; then
          echo "❌ AppImage tool not found at $APPIMAGE_TOOL"
          exit 1
        fi
        "$APPIMAGE_TOOL" WarpDeck.AppDir WarpDeck.AppImage
        
        # Move AppImage to workspace root for upload
        echo "📍 Current directory: $(pwd)"
        echo "📁 Files before move: $(ls -la WarpDeck.AppImage)"
        
        # Calculate path to workspace root from current location
        # We're in: warpdeck-flutter/warpdeck_gui/build/linux/x64/release/bundle
        # We need to go up 7 levels to get to workspace root
        mv WarpDeck.AppImage ../../../../../../..
        echo "✅ AppImage moved to workspace root"
        cd ../../../../../../..
        echo "📍 Workspace root directory: $(pwd)"  
        echo "📁 AppImage at workspace root: $(ls -la WarpDeck.AppImage)"

    - name: Upload Linux artifacts
      uses: actions/upload-artifact@v4
      with:
        name: warpdeck-linux
        path: |
          WarpDeck.AppImage
          warpdeck-cli/build/warpdeck

  release:
    name: Create Release
    needs: [build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download macOS artifacts
      uses: actions/download-artifact@v4
      with:
        name: warpdeck-macos
        path: ./artifacts/macos

    - name: Download Linux artifacts
      uses: actions/download-artifact@v4
      with:
        name: warpdeck-linux
        path: ./artifacts/linux

    - name: Prepare CLI assets with correct names
      run: |
        # Copy CLI binaries with correct names for release
        cp ./artifacts/macos/warpdeck-cli/build/warpdeck ./artifacts/macos/warpdeck-cli-macos
        cp ./artifacts/linux/warpdeck-cli/build/warpdeck ./artifacts/linux/warpdeck-cli-linux

    - name: Generate release tag
      id: tag
      run: |
        # Create a tag based on date and commit
        TAG="v$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)"
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "Generated tag: $TAG"

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: WarpDeck ${{ steps.tag.outputs.tag }}
        body: |
          ## WarpDeck Release ${{ steps.tag.outputs.tag }}
          
          🚀 **Automatic build from latest main branch**
          
          ### 📦 Downloads
          
          | Platform | Download | Size | Format |
          |----------|----------|------|--------|
          | **macOS** | [WarpDeck-macOS.dmg](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/WarpDeck-macOS.dmg) | ~25 MB | Universal Binary |
          | **Linux** | [WarpDeck.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/WarpDeck.AppImage) | ~45 MB | Portable |
          | **Steam Deck** | [WarpDeck.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/WarpDeck.AppImage) | ~45 MB | Optimized |
          
          ### 🔧 CLI Tools
          - macOS CLI: [warpdeck-cli-macos](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/warpdeck-cli-macos)
          - Linux CLI: [warpdeck-cli-linux](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/warpdeck-cli-linux)
          
          ### ✨ What's Included
          - 🔒 Privacy-first peer-to-peer file sharing
          - ⚡ Lightning-fast transfers over local network
          - 🎮 Steam Deck optimized with touch controls
          - 🌐 Cross-platform: macOS ↔ Linux ↔ Steam Deck
          - 🎨 Beautiful Material Design 3 interface
          
          ### 📝 Changes in this Build
          Built from commit: [`${{ github.sha }}`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ---
          
          **🔗 Quick Install:**
          ```bash
          # macOS
          curl -L -o WarpDeck.dmg https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/WarpDeck-macOS.dmg
          
          # Linux/Steam Deck
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.tag }}/WarpDeck.AppImage
          chmod +x WarpDeck.AppImage
          ```
        draft: false
        prerelease: false
        files: |
          ./artifacts/macos/WarpDeck-macOS.dmg
          ./artifacts/linux/WarpDeck.AppImage
          ./artifacts/macos/warpdeck-cli-macos
          ./artifacts/linux/warpdeck-cli-linux

    - name: Update latest release
      run: |
        # Tag this release as 'latest' for the download links in README
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Delete existing latest tag if it exists
        git tag -d latest 2>/dev/null || true
        git push origin :refs/tags/latest 2>/dev/null || true
        
        # Create new latest tag
        git tag latest
        git push origin latest